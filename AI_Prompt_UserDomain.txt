You are an experienced software engineer and product manager. 
I am building a Golang monorepo with a capability library called **Mora**, 
an API orchestration layer called **Clotho**, and a domain service called **Custos (User Domain)**.

---

## Context

- **Mora** → capability library (auth token signing/validation, logger, config, db, cache, mq, utils)
- **Clotho** → API orchestration layer (entry point, trust/zero trust, request routing)
- **Custos (User Domain)** → owns user identity, lifecycle, security, and authorization

---

## Custos Responsibilities

### 1. User Lifecycle Management
- User registration (C-end self-service, B-end admin-created)
- Activation / Freeze / Deletion
- Profile management (nickname, avatar, email, phone, extended profile)

### 2. Authentication
- Username + password login
- Phone/email OTP login (C-end)
- OAuth2.0 third-party login (Google, WeChat, Apple ID, etc.)
- Access/Refresh token mechanism (support rotation + state table)
- Multi-session management (web, mobile, tablet)
- Forced logout (token_version strategy)

### 3. Security
- Password hashing (bcrypt/argon2)
- Login failure limit (anti-brute-force)
- Two-factor authentication (2FA/MFA)
- Login & audit logs
- Abnormal login detection

### 4. Authorization (via Casbin)
- RBAC implemented with Casbin
- Custos does not maintain custom `roles/permissions` tables
- Casbin `casbin_rule` table stores role & permission policies
- Custos integrates Casbin Enforcer for runtime checks
- Custos provides wrapper APIs for managing roles/permissions by calling Casbin APIs
- Future: ABAC using Casbin models

### 5. OAuth2.0 Provider Capabilities (Optional)
- Provide `/authorize`, `/token`, `/userinfo`
- Support Grant Types: Authorization Code, Client Credentials, Refresh Token

### 6. Audit & Observability
- Login events (success/failure, IP, UA)
- Permission change logs
- Security events (forced logout, reused refresh token detection)
- Export to MQ/ES/Prometheus

---

## Out of Scope
- Trust/Zero Trust (device, IP, network validation → handled by Clotho)
- Infrastructure capabilities (logging, config, db, mq → handled by Mora)
- Other business domains (orders, payments, etc.)

---

## Database Schema (DDL)

### users
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(64) UNIQUE NOT NULL,
    email VARCHAR(128) UNIQUE,
    phone VARCHAR(32) UNIQUE,
    password_hash VARCHAR(255),
    user_type ENUM('customer','staff','partner') DEFAULT 'customer',
    tenant_id BIGINT NULL,
    status ENUM('active','disabled','locked','deleted') DEFAULT 'active',
    token_version INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### user_profiles
```sql
CREATE TABLE user_profiles (
    user_id BIGINT PRIMARY KEY,
    nickname VARCHAR(64),
    avatar VARCHAR(255),
    gender ENUM('male','female','other') DEFAULT 'other',
    birthday DATE,
    extra JSON,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### user_oauth
```sql
CREATE TABLE user_oauth (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    provider VARCHAR(64) NOT NULL,
    provider_uid VARCHAR(128) NOT NULL,
    access_token VARCHAR(255),
    refresh_token VARCHAR(255),
    expires_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(provider, provider_uid),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### refresh_tokens
```sql
CREATE TABLE refresh_tokens (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    token_hash CHAR(64) NOT NULL,
    is_used BOOLEAN DEFAULT FALSE,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### casbin_rule (used by Casbin Adapter)
```sql
CREATE TABLE casbin_rule (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    ptype VARCHAR(32) NOT NULL,
    v0 VARCHAR(255),
    v1 VARCHAR(255),
    v2 VARCHAR(255),
    v3 VARCHAR(255),
    v4 VARCHAR(255),
    v5 VARCHAR(255)
);
```

---

## Instructions to AI
When generating code or architecture:
- Assume **RBAC = Casbin**, no custom role/permission tables
- Generate Golang structs, APIs, middleware, and services based on Custos responsibilities
- Use Mora for common utilities (auth token signing, config, db connection, etc.)
- Integrate Casbin Enforcer in middleware for RBAC checks
- Generate starter code for: login, logout, token refresh, forced logout, audit logging, Casbin role assignment
- Follow clean architecture principles (Mora = capability library, Custos = user domain, Clotho = API orchestrator)
